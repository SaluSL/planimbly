{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/accounts/employee_option.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    </script>
{% endblock head %}

{% block content %}

<div id="vue-app">
    <nav style aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'units_manage' %}"
                                        class="breadcrumb-link">{{ user.user_org }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'employees_manage' %}"
                class="breadcrumb-link">Pracownicy</a></li>
            {% comment %} <li class="breadcrumb-item current-subpage">[[ employee_info.first_name ]] [[ employee_info.last_name ]]</li> {% endcomment %}
        </ol>
        {% comment %} <h2 class="breadcrumb-title">Zarządzanie pracownikiem </h2> {% endcomment %}
        <h2 class="breadcrumb-title">[[ employee_info.first_name ]] [[ employee_info.last_name ]] </h2>
        <hr class="breadcrumb" style="opacity: 1">
    </nav>

    <div class="emp_option_big_box">
        <div>
            <div class="emp_option_small_box"><h5>Imię</h5><input type="text" class="w-50 form-control" v-model="employee_info.first_name"></div>
            <div class="emp_option_small_box"><h5>Nazwisko</h5><input type="text" class="w-50 form-control" v-model="employee_info.last_name"></div>
            <div class="emp_option_small_box"><h5>Nazwa Użytkownika</h5><input type="text" class="w-50 form-control" v-model="employee_info.username" diasabled readonly></div>
        </div>
        <div>
            <div class="emp_option_small_box"><h5>ID</h5><input type="text" class="w-50 form-control" v-model="employee_info.id" diasabled readonly></div>
            <div class="emp_option_small_box"><h5>E-mail</h5><input type="text" class="w-50 form-control" v-model="employee_info.email"></div>
            <div class="emp_option_small_box"><h5>Etat</h5><input type="text" class="w-50 form-control" v-model="employee_info.job_time"></div>
        </div>
    </div>

    <button v-on:click="post_emp_data()" type="button" class="btn btn-outline-success" style="margin-bottom: 50px; margin-left: 10px">
        Zapisz zmiany
    </button>

    <div class="emp_option_wide_box">

        <div>
            <h5>Jednostki</h5>
            <div class="list-group">
                <div v-for="unit in employee_info.user_unit" :key="unit.id" class="list-group-item list-group-item-action position-static">
                    <div class="emp_option_table_box">
                        <div>[[ unit.name ]]</div>
                        <button v-on:click="remove_unit_for_employee(unit.id, unit.name)" class="material-icons" style="border: none; background-color: rgba(0, 0, 255, 0);">delete_outline</button>
                    </div>
                </div>  
            </div> 
            <button data-bs-target="#pickUnitForEmployee" data-bs-toggle="modal" data-bs-dismiss="modal" class="btn btn-outline-primary" style="margin-top: 15px; margin-bottom: 15px">Dodaj</button>                 
        </div>

        <div>
            <h5>Działy</h5>
            <div class="list-group">
                <div v-for="workplace in employee_info.user_workplace" :key="workplace.id" class="list-group-item list-group-item-action position-static">
                    <div class="emp_option_table_box">
                        <div>[[ workplace.name ]]</div>
                        <div>[[ get_unit_name(workplace) ]]</div>
                        <button v-on:click="remove_workplace_for_employee(workplace.id, workplace.name)" class="material-icons" style="border: none; background-color: rgba(0, 0, 255, 0);">delete_outline</button>
                    </div>
                </div>
            </div>
            <button data-bs-target="#pickWorkplaceForEmployee" data-bs-toggle="modal" data-bs-dismiss="modal" class="btn btn-outline-primary" style="margin-top: 15px; margin-bottom: 15px">Dodaj</button> 
        </div>
        
        <div>
            <h5>Preferencje zmianowe</h5>
            <div class="list-group">
                <div v-for="preference in preferences_list" :key="preference.id" class="list-group-item list-group-item-action position-static">
                    <div class="emp_option_table_box">
                        <div>[[ preference.shift_type ]] [[ preference.active_days ]]</div>
                        <button v-on:click="remove_preference(preference.id)" class="material-icons" style="border: none; background-color: rgba(0, 0, 255, 0);">delete_outline</button>
                    </div>
                </div>
            </div>
            <button data-bs-target="#addPreferenceModal" data-bs-toggle="modal" data-bs-dismiss="modal" class="btn btn-outline-primary" style="margin-top: 15px; margin-bottom: 15px">Dodaj</button> 
        </div>
    </div>

    <div class="modal fade" id="pickUnitForEmployee" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-header">
                        <h5 class="modal-title">Wybierz jednostkę</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    
                    <div class="list-group">
                        <div v-for="unit in unit_list" v-on:click="add_unit_for_employee(unit.id, unit.name)" class="list-group-item list-group-item-action">
                            <div class="fw-bold"> [[ unit.name ]] </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pickWorkplaceForEmployee" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                      <h5 class="modal-title">Wybierz jednostkę</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <select id="unitSelect" class="form-select" v-model="selected_unit" v-on:change="workplace_list_fetch">
                        <option v-for="unit in employee_info.user_unit" :value="unit.id">
                            [[ unit.name ]]
                        </option>
                    </select>

                    <div class="list-group" style="margin-top: 15px">
                        <div v-for="workplace in workplaces_list" v-on:click="add_workplace_for_employee(workplace.id, workplace.name)" class="list-group-item list-group-item-action">
                            <div class="fw-bold">[[ workplace.name ]]</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addPreferenceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                      <h5 class="modal-title">Wybierz jednostkę</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    {% comment %} <select id="unitSelect" class="form-select" v-model="selected_unit" v-on:change="workplace_list_fetch">
                        <option v-for="unit in employee_info.user_unit" :value="unit.id">
                            [[ unit.name ]]
                        </option>
                    </select> {% endcomment %}

                    <h5 class="modal-title" style="margin-bottom: 15px">Wybierz dział</h5>

                    <select id="workplaceSelect" class="form-select" v-model="selected_workplace" v-on:change="shiftType_list_fetch">
                        <option v-for="workplace of employee_info.user_workplace" :value="workplace.id">
                            <div class="fw-bold">[[ workplace.name ]]: [[ employee_info.user_unit ]]</div>
                        </option>
                    </select>

                    <div class="list-group" style="margin-top: 15px">
                        <div v-for="shiftType in shiftType_list" v-on:click="add_preference(shiftType.id)" class="list-group-item list-group-item-action">
                            <div class="fw-bold"> ID: [[ shiftType.id ]] Nazwa: [[ shiftType.name ]] </div>
                        </div>
                    </div>

                    <h5 class="modal-title" style="margin-top: 15px">Wpisz active days</h5>

                    <input type="text" class="form-control" style="margin-top: 15px" v-model="preference_active_days">

                </div>
            </div>
        </div>
    </div>

</div>

{% endblock content %}

{% block vue-content %}
    <script type="module">  
        const {createApp} = Vue
        var vue_app = createApp({
            delimiters: ["[[", "]]"],
            data() {
                return {
                    employee_id: {{ pk }},
                    email: '',
                    username: '',
                    first_name: '',
                    last_name: '',
                    job_time: 0,
                    preference_active_days: '',

                    employee_values: null,
                    unit_list: null,
                    workplaces_list: null,
                    shiftType_list: null,
                    selected_unit: null,
                    selected_workplace: null,
                    preferences_list: null,
                    shift_list: null,

                    response: null,
                    response_emp_data: null,
                    response_unit_data: null,
                    response_workplace_data: null,
                    response_shiftType_data: null,
                    response_pref_data: null,

                    base_url: '',
                    units_url: '',
                    emp_preferences_url: '',

                    // API COUNTER: 7
                }
            },
            computed: {
                workplace_url: {
                    get() {
                        return '{% url 'workplace-list' 123456789 %}'.replace(/123456789/, this.selected_unit);
                    }
                },
                shiftType_url: {
                    get() {
                        return '{% url 'shiftType-list' 123456789 %}'.replace(/123456789/, this.selected_workplace);
                    }
                },
                employee_info() {
                    if (this.employee_values != null){
                        return this.employee_values
                    }
                    else{
                        return { email: null, first_name: null, id: null, job_time: null, last_name: null, username: null, user_unit: null, user_workplace: null }
                    }
                    
                },
            },
            methods: {
                get_unit_name(workplace) {
                    if (this.employee_info != null){
                        return this.employee_info.user_unit.find((Object) => Object.id == workplace.workplace_unit).name
                    }
                    
                },
                fetch_data() {
                    this.base_url = '{% url 'employee-detail' 123456789 %}'.replace(/123456789/, this.employee_id);
                    axios
                        .get(this.base_url)
                        .then(response_emp_data => (this.employee_values = response_emp_data.data))
                        .then(() => console.log(this.employee_values))
                },
                post_emp_data(){
                    swal({
                        title: "Czy chcesz zatwierdzić zmiany?",
                        icon: "info",
                        buttons: true,
                    })
                        .then((willAdd) => {
                            if (willAdd) {
                                axios
                                    .put(this.base_url,
                                        {
                                            email: this.employee_info.email,
                                            username: this.employee_info.username,
                                            first_name: this.employee_info.first_name,
                                            last_name: this.employee_info.last_name,
                                            job_time: this.employee_info.job_time,
                                        }
                                    )
                                    .then(() => this.fetch_data())
                                    .catch(error => {
                                            this.response = error.response.data
                                            }
                                    )
                            }
                        });
                },
                fetch_preferences_data(){
                    this.emp_preferences_url = '{% url 'preference-list' %}' + '?employee=' + this.employee_id
                    axios
                        .get(this.emp_preferences_url)
                        .then(response_pref_data => (this.preferences_list = response_pref_data.data))
                },
                fetch_unit_data(){
                    this.units_url = '{% url 'unit-list' %}';
                    axios
                        .get(this.units_url)
                        .then(response_unit_data => (this.unit_list = response_unit_data.data));
                },
                workplace_list_filter(){
                    if (this.workplaces_list != null){
                        for(let workplace of this.workplaces_list){
                            let flag = true;
                            for(let workplace2 of this.employee_info.user_workplace){
                                if (workplace.id == workplace2.id){
                                    flag = false;
                                }
                            }
                            if (flag == false) {
                                this.workplaces_list.splice(this.workplaces_list.indexOf(workplace), 1);
                            }
                        }
                    }
                },
                workplace_list_fetch() {
                    if (this.selected_unit != null){
                        axios
                            .get(this.workplace_url)
                            .then(response_workplace_data => (this.workplaces_list = response_workplace_data.data))
                    }
                    
                },
                shiftType_list_fetch() {
                    if (this.selected_workplace != null){
                        axios
                            .get(this.shiftType_url)
                            .then(response_shiftType_data => (this.shiftType_list = response_shiftType_data.data))
                    }
                    
                },
                remove_preference(pref_id){
                    let remove_preference_url = '{% url 'preference-list' %}' + pref_id
                    axios
                    .delete(remove_preference_url,
                        {
                            id: pref_id,
                        }
                    ).then(() => this.fetch_preferences_data());
                },
                remove_unit_for_employee(unit_id, unit_name) {
                    swal({
                        title: "Czy na pewno chcesz usunąć jednostkę " + unit_name,
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                    })
                        .then((willAdd) => {
                            if (willAdd) {
                                let remove_unit_url = '{% url 'employee_to_unit_api' 123456789 %}'.replace(/123456789/, unit_id);
                                axios
                                .post(remove_unit_url,
                                    {
                                        pk: this.employee_id,
                                        action: 'delete'
                                    }
                                ).then(() => this.fetch_data());
                                
                            }
                        });
                },
                add_unit_for_employee(unit_id, unit_name) {
                    swal({
                        title: "Potwierdź dodanaie jednostki " + unit_name,
                        icon: "info",
                        buttons: true,
                        dangerMode: false,
                    })
                        .then((willAdd) => {
                            if (willAdd) {
                                let remove_unit_url = '{% url 'employee_to_unit_api' 123456789 %}'.replace(/123456789/, unit_id);
                                axios
                                .post(remove_unit_url,
                                    {
                                        pk: this.employee_id,
                                        action: 'add'
                                    }
                                ).then(() => this.fetch_data());
                                
                            }
                        });
                },
                remove_workplace_for_employee(workplace_id, workplace_name) {
                    swal({
                        title: "Potwierdź dodanie jednostki " + workplace_name,
                        icon: "info",
                        buttons: true,
                        dangerMode: false,
                    })
                        .then((willAdd) => {
                            if (willAdd) {
                                let remove_workplace_url = '{% url 'employee_to_workplace_api' 123456789 %}'.replace(/123456789/, workplace_id);
                                axios
                                .post(remove_workplace_url,
                                    {
                                        pk: this.employee_id,
                                        action: 'delete'
                                    }
                                ).then(() => this.fetch_data());
                            }
                        });
                },
                add_workplace_for_employee(workplace_id, workplace_name) {
                    swal({
                        title: "Potwierdź dodanie działu " + workplace_name,
                        icon: "info",
                        buttons: true,
                        dangerMode: false,
                    })
                        .then((willAdd) => {
                            if (willAdd) {
                                let remove_workplace_url = '{% url 'employee_to_workplace_api' 123456789 %}'.replace(/123456789/, workplace_id);
                                axios
                                .post(remove_workplace_url,
                                    {
                                        pk: this.employee_id,
                                        action: 'add'
                                    }
                                ).then(() => this.fetch_data());
                            }
                        });
                },
                add_preference(shifttype){
                    swal({
                        title: "Potwierdź dodanaie preferencji",
                        icon: "info",
                        buttons: true,
                        dangerMode: false,
                    })
                        .then((willAdd) => {
                            if (willAdd) {
                                let add_preference_url = '{% url 'preference-list' %}'
                                axios
                                .post(add_preference_url, 
                                    {
                                        shift_type: shifttype,
                                        employee: this.employee_id,
                                        active_days: this.preference_active_days.toString(),
                                    }
                                ).then(() => this.fetch_preferences_data());
                                
                            }
                        });
                },
                st_numbers_to_list(numbers){

                },
                st_list_to_text(){

                },
                st_list_to_numbers(){

                }
            },
            mounted() {
                this.fetch_data()
                this.fetch_unit_data()
                this.workplace_list_fetch()
                this.fetch_preferences_data()
            }
        }).mount('#vue-app');
    </script>
{% endblock vue-content %}