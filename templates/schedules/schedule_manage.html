{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{#START/added calendar#}
{% block head %}
    <link rel="stylesheet" href="{% static 'css/schedules/schedule.css' %}">
    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    </script>
{% endblock head %}
{#STOP/added calendar#}

{% block content %}
    <nav style aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'units_manage' %}"
                                           class="breadcrumb-link">{{ user.user_org }}</a></li>
            <li class="breadcrumb-item current-subpage">Grafiki</li>
        </ol>
        <h2 class="breadcrumb-title"><a href="{% url 'units_manage' %}">
            <i class="material-icons breadcrumb-go-back-icon">arrow_back_ios</i></a>Zarządzanie grafikami</h2>
        </h2>
        <hr class="breadcrumb" style="opacity: 1">
    </nav>
    {% if is_any_workplace %}
    {#    START/added calendar#}
    <div id="vue-app">
        <div class="row m-2">
            <div class="col mb-1">
                <select class="form-select" v-model="month_cal" v-on:change="fetch_data">
                    <option v-for="label in month_labels" :value="label.id">
                        [[ label.name ]]
                    </option>
                </select>
            </div>
            <div class="col mb-1">
                <select class="form-select" v-model="year_cal" v-on:change="fetch_data">
                    <option v-for="av_year in available_years" :value="av_year">
                        [[ av_year ]]
                    </option>
                </select>
            </div>
            <div class="col mb-1">
                <select class="form-select" v-model="selected_unit" v-on:change="change_workplace">
                    <option v-for="unit in select_unit" :value="unit.id">
                        [[ unit.name ]]
                    </option>
                </select>
            </div>
            <div class="col mb-1">
                <select class="form-select" v-model="selected_workplace" v-on:change="fetch_data">
                    <option v-for="workplace in current_workplace" :value="workplace.id">
                        [[ workplace.name ]]
                    </option>
                </select>
            </div>
            <div class="col d-flex justify-content-center">
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal"
                        data-bs-target="#generateScheduleModal">
                    Wygeneruj grafik
                </button>
            </div>
        </div>
        <!-- <hr class="breadcrumb" style="height: 1px;"> -->

        {#        <div id="calendar-filters" class="filter-calendar-container">#}
        {#            #}
        {#        </div>#}

        <work-calendar
                :year="year_cal"
                :month="month_cal"
                :unit_id="selected_unit"
                :workplace_id="selected_workplace"
                :employee_id="employee_id"
                :show_for_workplace="show_for_workplace"
                :schedule="fetched_schedule"
                :available_workers="available_workers"
                :available_shift_types="available_shift_types">
        </work-calendar>

            {#    END/added calendar#}

        <div class="modal fade" id="generateScheduleModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="schedule_form" v-on:submit.prevent="create_schedule">
                        {% csrf_token %}
                        <div class="modal-header" v-if="loading == false">
                            <h5 class="modal-title" id="generateScheduleLabel">Wygeneruj nowy grafik</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body" v-if="loading == false">
                            <div class="row g-3 d-flex align-items-center">
                                <div class="col-6">
                                    <label for="year" class="form-label modal-style">Rok</label>
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" v-model="year" required>
                                </div>

                                <div class="col-6">
                                    <label for="month" class="form-label modal-style">Miesiąc</label>
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" v-model="month" required>
                                </div>

                                <label class="form-label">Działy uwzględnione w grafiku:</label>
                                <div class="row mx-0 my-1 d-flex align-items-center" v-for="(workplace, i) in current_workplace" :key="workplace.id">
                                    <div class="col-6">
                                        <label class="form-label modal-style">[[ workplace.name ]] </label>
                                    </div>
                                    <div class="col-6 d-flex align-items-center">
                                        <input v-bind:id="workplace.id" v-bind:value="workplace.id"
                                               class="form-check-input" style="margin: 0px;" type="checkbox" checked
                                               v-model="checked_workplace">
                                    </div>
                                </div>

                                </div>
                            </div>

                        <div class="modal-footer" v-if="loading == false">
                            <button type="submit" class="btn btn-outline-primary">Wygeneruj</button>
                        </div>

                            <div v-if="loading">
                                <h3 class="text-center">Waiting</h3>
                                <img src="{% static 'img/Loading_icon.gif' %}" alt="Be patient"/>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <span>Brak działów</span>
    {% endif %}
{% endblock %}


{% block vue-content %}
    {% if is_any_workplace %}
        <script type="module">
            import WorkCalendar from "{% static 'js/components/WorkCalendar.js' %}";

        const {createApp} = Vue
        createApp({
            delimiters: ["[[", "]]"],
            components: {
                WorkCalendar,
            },
            data() {
                return {
                    fetched_schedule: null,
                    employee_id: 1,
                    show_for_workplace: true,
                    selected_unit: {{ default_unit }},
                    select_unit: {{ select_unit | safe}},
                    select_workplace: {{ select_workplace | safe }},
                    selected_workplace: null,
                    create_schedule_url: '{% url 'schedule_create' %}',
                    year: new Date().getFullYear(),
                    month: new Date().getMonth(),
                    year_cal: new Date().getFullYear(),
                    month_cal: new Date().getMonth()+1,
                    checked_workplace: [],
                    loading: false,
                    available_workers: null,
                    available_shift_types: null,

                    month_labels: [
                        {id: 1, name: 'Styczeń'},
                        {id: 2, name: 'Luty'},
                        {id: 3, name: 'Marzec'},
                        {id: 4, name: 'Kwiecień'},
                        {id: 5, name: 'Maj'},
                        {id: 6, name: 'Czerwiec'},
                        {id: 7, name: 'Lipiec'},
                        {id: 8, name: 'Sierpień'},
                        {id: 9, name: 'Wrzesień'},
                        {id: 10, name: 'Październik'},
                        {id: 11, name: 'Listopad'},
                        {id: 12, name: 'Grudzień'},
                    ],
                    available_years: [
                        new Date().getFullYear() - 5,
                        new Date().getFullYear() - 4,
                        new Date().getFullYear() - 3,
                        new Date().getFullYear() - 2,
                        new Date().getFullYear() - 1,
                        new Date().getFullYear(),
                        new Date().getFullYear() + 1,
                        new Date().getFullYear() + 2,
                    ],
                }
            },
            methods: {
                create_schedule() {
                    this.loading = true
                    axios
                        .post(this.create_schedule_url,
                            {
                                workplace_list: this.checked_workplace,
                                year: this.year,
                                month: this.month
                            }
                        )
                        .then(response => {
                                this.loading = false
                            }
                        )
                },
                fetch_data() {
                    axios
                        .get(this.base_url, {params: {'year': this.year_cal, 'month': this.month_cal}})
                        .then(response => {
                                this.fetched_schedule = response.data;
                            }
                        );
                    axios
                        .get(this.employee_list_url)
                        .then(response => {
                                this.available_workers = response.data;
                            }
                        );
                    axios
                        .get(this.shift_type_list_url)
                        .then(response => {
                                this.available_shift_types = response.data;
                            }
                        );
                },
                change_workplace() {
                    try {
                        this.selected_workplace = this.select_workplace[this.selected_unit][0]['id']
                    } catch {

                    }
                    this.fetch_data()
                },
            },
            computed: {
                base_url: {
                    get() {
                        return '{% url 'schedule_get' 123456789 %}'.replace(/123456789/, this.selected_workplace);
                    }
                },
                employee_list_url: {
                    get() {
                        return '{% url 'employee-list' %}';
                    }
                },
                shift_type_list_url: {
                    get() {
                        return '{% url 'shiftType-list' 123456789 %}'.replace(/123456789/, this.selected_workplace);
                    }
                },
                current_workplace: {
                    get() {
                        return this.select_workplace[this.selected_unit]
                    }
                }
            },
            mounted() {

                try {
                    this.selected_workplace = this.select_workplace[this.selected_unit][0]['id']
                } catch {

                }
                this.fetch_data()
            },
        }).mount('#vue-app');

        </script>
    {% endif %}
{% endblock vue-content %}
