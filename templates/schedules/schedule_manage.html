{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/schedules/uam-schedule.css' %}">
    <link rel="stylesheet" href="{% static 'css/schedules/report.css' %}">
    <link rel="stylesheet" href="{% static 'css/tooltip.css' %}">
    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
    <script>
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    </script>
{% endblock head %}

{% block content %}
    {% comment %} <nav style aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'units_manage' %}"
                                           class="breadcrumb-link">{{ user.user_org }}</a></li>
            <li class="breadcrumb-item current-subpage">Grafiki</li>
        </ol>
        <h2 class="breadcrumb-title"><a href="{% url 'units_manage' %}">
            <i class="material-icons breadcrumb-go-back-icon">arrow_back_ios</i></a>Zarządzanie grafikami</h2>
        </h2>
        <hr class="breadcrumb" style="opacity: 1">
    </nav> {% endcomment %}
    {% if is_any_workplace %}
 
    <div id="vue-app" v-cloak>
        {% comment %}<div class="col d-flex justify-content-start">
            <h3 class="content-title">Grafiki</h3>
        </div>{% endcomment %} 
        <div class="row m-2"> 
            <div class="col mb-1">
                <select class="form-select" v-model="month_cal" v-on:change="fetch_data">
                    <option v-for="label in month_labels" :value="label.id">
                        [[ label.name ]]
                    </option>
                </select>
            </div>
            <div class="col mb-1">
                <select class="form-select" v-model="year_cal" v-on:change="fetch_data">
                    <option v-for="av_year in available_years" :value="av_year">
                        [[ av_year ]]
                    </option>
                </select>
            </div>
            <div class="col mb-1">
                <select class="form-select" v-model="selected_unit" v-on:change="change_workplace">
                    <option v-for="unit in select_unit" :value="unit.id">
                        [[ unit.name ]]
                    </option>
                </select>
            </div>
            <div class="col mb-1">
                <select class="form-select" v-model="selected_workplace" v-on:change="fetch_data">
                    <option v-for="workplace in current_workplace" :value="workplace.id">
                        [[ workplace.name ]]
                    </option>
                </select>
            </div>

            <div class="col d-flex justify-content-end" style="padding-right: 0px">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                        data-bs-target="#generateReportModal" v-if="available_workplace_report.length > 0">
                    Wygeneruj raport
                </button>
                
                <tooltip v-else text="Nie wykryto grafiku dla danego miesiąca..." elementid="NoScheduleButton"> 
                    <button id="NoScheduleButton" type="button" class="btn btn-outline-primary" disabled style="z-index: -1;">
                        Wygeneruj raport
                    </button> 
                </tooltip>
            </div>
            <div class="col d-flex justify-content-end" style="padding-left: 0px">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#generateScheduleModal">
                    Wygeneruj grafik
                </button>
            </div>

        </div>
        <work-calendar v-on:call-rest-api="callApiManualChange"
                :year="year_cal"
                :month="month_cal"
                :unit_id="selected_unit"
                :workplace_id="selected_workplace"
                :employee_id="employee_id"
                :show_for_workplace="show_for_workplace"
                :schedule="fetched_schedule"
                :available_workers="available_workers"
                :available_shift_types="available_shift_types">
        </work-calendar>

        <div>
            <h5 style="margin-top: 25px; margin-top: 20px;">Statystyki dla jednostki</h5>

            <table class="w-75 table">
                <thead>
                <tr>
                    <th scope="col">lp.</th>
                    <th scope="col">Pracownik</th>
                    <th scope="col">Godziny/Etat</th>
                    <th scope="col">Bilans</th>
                    <th v-for="shift in shifttype_name_list" scope="col">[[ shift ]]</th>
                    <th scope="col">Godziny L4</th>
                    <th scope="col">Godziny urlopu</th>
                    <th scope="col">Inne nieobecości</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="stat in statistics">
                    <td>[[ stat.order_number ]]</td>
                    <td>[[ stat.name ]]</td>
                    <td>[[ stat.hours ]]/[[ stat.jobtime ]]h</td>
                        <td v-if="calculate_diff(stat.hours, stat.jobtime) < 0" style="color: red;">[[ calculate_diff(stat.hours, stat.jobtime) ]]</td>
                        <td v-if="calculate_diff(stat.hours, stat.jobtime) == 0">[[ calculate_diff(stat.hours, stat.jobtime) ]]</td>
                        <td v-if="calculate_diff(stat.hours, stat.jobtime) > 0" style="color: green;">[[ calculate_diff(stat.hours, stat.jobtime) ]]</td>
                        <td v-for="shift in shifttype_name_list">[[ return_shift_count(stat.shift_type, shift) ]]</td>
                        <td>[[ return_sick_or_vac(stat.SICK) ]]</td>
                        <td>[[ return_sick_or_vac(stat.VAC) ]]</td>
                        <td>[[ return_sick_or_vac(stat.OTHER) ]]</td>
                    </tr>
                </tbody>
            </table>
               


            {% comment %} <div class="stat_table" style="margin-left: 20px">
                <div class="stat_box_name"><p style="font-weight: bold; margin-bottom: 5px;">Pracownik</p></div>
                <div class="stat_box_name" style="width: 160px"><p style="font-weight: bold; margin-bottom: 5px;">Godziny/Etat</p></div>
                <div class="stat_box_name"><p style="font-weight: bold; margin-bottom: 5px;">Ilość zmian</p></div>
            </div>
            <ul>
                <li v-for="stat in statistics">
                    <div class="stat_table">
                        <div class="stat_box_name">[[ stat.name ]]</div>
                        <div class="stat_box">[[ stat.hours ]]/[[ stat.jobtime ]]h</div>
                        <div class="stat_box">
                            <span v-for="(type, index) in stat.shift_type">
                                [[ index ]]:[[ type ]] &nbsp;</span>
                        </div>
                    </div>
                </li>
            </ul> {% endcomment %}        
        
        </div>

        <div class="modal fade" id="generateReportModal" tabindex="-1" aria-labelledby="generateReportLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Wygeneruj raport dla [[select_unit.find(unit => unit.id === selected_unit).name]]</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 d-flex align-items-center">
                        <div class="col-6">
                            <label for="year" class="form-label modal-style">Rok</label>
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control" v-model="year_report" required disabled>
                        </div>

                        <div class="col-6">
                            <label for="month" class="form-label modal-style">Miesiąc</label>
                        </div>
                        <div class="col-6">
                            {% comment %} <input type="number" class="form-control" v-model="month" required> {% endcomment %}
                            <select class="form-control overflow-hidden" v-model="month_report" disabled>
                                <option v-for="label in month_labels" :value="label.id">
                                    [[ label.name ]]
                                </option>
                            </select>
                        </div>
                        
                        <div class="col6 d-flex flex-column">
                            <div>
                                <table>
                                    <tbody>
                                        <td>
                                            <input class="form-check-input" type="checkbox" v-model="attach_days_employees_report" id="attachDaysEmployeesReport">
                                            <label class="form-check-label ms-2 mb-4" for="attachDaysEmployeesReport">
                                                Dołącz zestawienie dni pracy per pracownik
                                            </label>
                                        </td>
                                        <td>
                                            <tooltip text="Zestawnienia bardzo to fajna sprawa">
                                                <div class="material-icons" style="font-size: 0.93rem; color: #616161; margin-bottom: 30px;">help</div>
                                            </tooltip>
                                        </td>
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <table>
                                    <tbody>
                                        <td>
                                            <input class="form-check-input" type="checkbox" v-model="attach_statistics_employees_report" id="attachStatisticsEmployeesReport">
                                            <label class="form-check-label ms-2 mb-4" for="attachStatisticsEmployeesReport">
                                                Dołącz statystyki dla pracowników
                                            </label>
                                        </td>
                                        <td>
                                            <tooltip text="Statystyki bardzo to fajna sprawa">
                                                <div class="material-icons" style="font-size: 0.93rem; color: #616161; margin-bottom: 30px;">help</div>
                                            </tooltip>
                                        </td>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                        
                        <label class="form-label">Działy uwzględnione w raporcie:</label>
                            <div class="list-group">
                                <div v-for="workplace_shifts in shift_types_for_each_workplace" class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <input v-bind:id="workplace_shifts.workplace.id" v-bind:value="workplace_shifts.workplace.id"
                                                        class="form-check-input me-2" style="margin: 0px;" type="checkbox"
                                                        v-model="checked_workplace_report" v-if="available_workplace_report.includes(workplace_shifts.workplace.id)">
                                            <input v-bind:id="workplace_shifts.workplace.id" v-bind:value="workplace_shifts.workplace.id"
                                                        class="form-check-input me-2" style="margin: 0px;" type="checkbox"
                                                        v-model="checked_workplace_report" v-else disabled>
                                                        
                                            <div>[[workplace_shifts.workplace.name]]</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" v-if="checked_workplace_report.length > 0" data-bs-toggle="modal" data-bs-target="#reportModal"
                     v-on:click="fill_schedule_for_chosen_workplace(schedule_for_each_workplace, checked_workplace_report)">Generuj</button>
                  <button type="button" class="btn btn-primary" disabled v-else>Generuj</button>
                </div>
              </div>
            </div>
        </div>

        <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Raport</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div id="report">
                    <schedule-report ref="report"
                        :year="year_report"
                        :month="month_report"
                        :attach_days_employees_report="attach_days_employees_report"
                        :attach_statistics_employees_report="attach_statistics_employees_report"
                        :schedule_for_each_workplace="schedule_for_chosen_workplace"
                        :workdays_for_each_employee="workdays_for_each_employee"
                        :chosen_workplaces="checked_workplace_report"
                        :margin_top_for_statistics="margin_top_for_statistics_report"
                        :shifttype_name_list="shifttype_name_list">
                    </schedule-report>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" v-on:click="set_margin_top_for_report_statistics(); 
                                                                            printToPdf();">Zapisz do PDF</button>
                </div>
              </div>
            </div>
        </div>

        <div class="modal fade" id="generateScheduleModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 500px">
                <div class="modal-content">
                    <form id="schedule_form" v-on:submit.prevent="create_schedule">
                        {% csrf_token %}
                        <div class="modal-header" v-if="loading == false">
                            <h5 class="modal-title" id="generateScheduleLabel">Wygeneruj nowy grafik dla [[select_unit.find(unit => unit.id === selected_unit).name]]</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body" v-if="loading == false">
                            <div class="row g-3 d-flex align-items-center">
                                <div class="col-6">
                                    <label for="year" class="form-label modal-style">Rok</label>
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" v-model="year" required>
                                </div>

                                <div class="col-6">
                                    <label for="month" class="form-label modal-style">Miesiąc</label>
                                </div>
                                <div class="col-6">
                                    {% comment %} <input type="number" class="form-control" v-model="month" required> {% endcomment %}
                                    <select class="form-select overflow-hidden" v-model="month">
                                        <option v-for="label in month_labels" :value="label.id">
                                            [[ label.name ]]
                                        </option>
                                    </select>
                                </div>

                                <label class="form-label">Działy uwzględnione w grafiku:</label>
                                <div class="list-group">
                                    <div v-for="workplace_shifts in shift_types_for_each_workplace" class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center">
                                                <input v-bind:id="workplace_shifts.workplace.id" v-bind:value="workplace_shifts.workplace.id"
                                                            class="form-check-input me-2" style="margin: 0px;" type="checkbox"
                                                            v-model="checked_workplace">
                                                <div class="fw-bold">[[workplace_shifts.workplace.name]]</div>
                                            </div>
                                        </div>
                                        <div v-for="shiftType in workplace_shifts.shiftTypes">
                                            <div v-if="shiftType.is_used"  class="list-group-item">
                                                <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                                                    [[shiftType.name]]
                                                    <span class="badge rounded-pill bg-primary d-inline-flex">[[shiftType.hour_start.toString().slice(0, 5) + " - " + shiftType.hour_end.toString().slice(0, 5)]]</span>
                                                    {% comment %} <div>
                                                        <div v-for="abbr in active_days_to_string_abbr_array(shiftType.active_days)" class="d-inline-flex">
                                                            <span class="badge bg-light text-dark me-1">[[abbr]]</span>
                                                        </div>
                                                    </div> {% endcomment %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer" v-if="loading == false">
                            <button type="submit" class="btn btn-primary" v-if="checked_workplace.length > 0" v-on:click="on_generation_start_schedule">Wygeneruj</button>
                            <button type="button" class="btn btn-primary disabled" v-else>Wygeneruj</button>
                        </div>

                            <div v-if="loading" class="modal-body">
                                <h3 class="text-center mb-5">Generowanie grafiku...</h3>
                                <!--<img src="{% static 'img/Loading_icon.gif' %}" alt="Be patient"/>-->
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-lg text-primary" role="status">
                                        <span class="visually-hidden">Waiting...</span>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

       
    </div>
    {% else %}
        <span>Brak działów</span>
    {% endif %}
{% endblock %}


{% block vue-content %}
    {% if is_any_workplace %}
        <script type="module">
        import WorkCalendar from "{% static 'js/components/WorkCalendar.js' %}";
        import ScheduleReport from "{% static 'js/components/ScheduleReport.js' %}";
        import tooltip from "{% static 'js/components/tooltip.js' %}";

        const {createApp} = Vue
        createApp({
            delimiters: ["[[", "]]"],
            components: {
                WorkCalendar,
                ScheduleReport,
                tooltip,
            },
            data() {
                return {
                    fetched_schedule: null,
                    employee_id: 1,
                    show_for_workplace: true,
                    selected_unit: {{ default_unit }},
                    select_unit: {{ select_unit | safe}},
                    select_workplace: {{ select_workplace | safe }},
                    selected_workplace: null,
                    create_schedule_url: '{% url 'schedule_create' %}',
                    year:  null,//new Date().getFullYear(),
                    month: null,//new Date().getMonth() + 1,
                    year_cal: new Date().getFullYear(),
                    month_cal: new Date().getMonth() + 1,
                    year_report: null,//new Date().getFullYear(),
                    month_report: null,//new Date().getMonth() + 1,
                    checked_workplace: [],
                    checked_workplace_report: [],
                    available_workplace_report: [],
                    loading: false,
                    available_workers: null,
                    available_shift_types: null,
                    statistics: null,
                    shift_types_for_each_workplace: [],
                    schedule_for_each_workplace: [],
                    schedule_for_chosen_workplace: [],
                    workdays_for_each_employee: null,
                    attach_days_employees_report: true,
                    attach_statistics_employees_report: true,
                    shifttype_name_list: [],
                    margin_top_for_statistics_report: 0,
                    use_huey_for_scheduling: '{{ use_huey }}',
                    month_labels: [
                        {id: 1, name: 'Styczeń'},
                        {id: 2, name: 'Luty'},
                        {id: 3, name: 'Marzec'},
                        {id: 4, name: 'Kwiecień'},
                        {id: 5, name: 'Maj'},
                        {id: 6, name: 'Czerwiec'},
                        {id: 7, name: 'Lipiec'},
                        {id: 8, name: 'Sierpień'},
                        {id: 9, name: 'Wrzesień'},
                        {id: 10, name: 'Październik'},
                        {id: 11, name: 'Listopad'},
                        {id: 12, name: 'Grudzień'},
                    ],
                    available_years: [
                        new Date().getFullYear() - 5,
                        new Date().getFullYear() - 4,
                        new Date().getFullYear() - 3,
                        new Date().getFullYear() - 2,
                        new Date().getFullYear() - 1,
                        new Date().getFullYear(),
                        new Date().getFullYear() + 1,
                        new Date().getFullYear() + 2,
                        new Date().getFullYear() + 3,
                        new Date().getFullYear() + 4,
                        new Date().getFullYear() + 5,
                    ],
                }
            },
            methods: {
                on_generation_start_schedule() {
                    if (this.is_huey_used_for_scheduling()) {
                        console.log('huey used');
                        window.location.href = '{% url 'schedule_generating' %}'
                    }
                },
                is_huey_used_for_scheduling() {
                    return this.use_huey_for_scheduling === 'True' ? true : false;
                },
                // set margin, so statistics are always on another page
                set_margin_top_for_report_statistics() {
                    const PDF_PAGE_LANDSCAPE_PX_HEIGHT_CHROMIUM = 803;
                    const REPORT_MARGINS_PX = 28; // margins set in report.css .PN-pdf-container
                    const report_elemets_without_statistics_px_height = document.getElementById('report_element_to_measure').clientHeight;
                    const additional_margin_for_statistics = 18;

                    this.margin_top_for_statistics_report = PDF_PAGE_LANDSCAPE_PX_HEIGHT_CHROMIUM -
                                                            (( report_elemets_without_statistics_px_height + ( 2 * REPORT_MARGINS_PX ) ) % 
                                                            PDF_PAGE_LANDSCAPE_PX_HEIGHT_CHROMIUM) +
                                                            REPORT_MARGINS_PX +
                                                            additional_margin_for_statistics;
                },

                sort_object_of_objects(data, attr) {
                    var arr = [];
                    for (var prop in data) {
                        if (data.hasOwnProperty(prop)) {
                            var obj = {};
                            obj[prop] = data[prop];
                            obj.tempSortName = data[prop][attr];
                            arr.push(obj);
                        }
                    }
                
                    arr.sort(function(a, b) {
                        var at = a.tempSortName,
                            bt = b.tempSortName;
                        return at > bt ? 1 : ( at < bt ? -1 : 0 );
                    });
                
                    var result = [];
                    for (var i=0, l=arr.length; i<l; i++) {
                        var obj = arr[i];
                        delete obj.tempSortName;
                        for (var prop in obj) {
                            if (obj.hasOwnProperty(prop)) {
                                var id = prop;
                            }
                        }
                        var item = obj[id];
                        result.push(item);
                    }
                    return result;
                },
                // month&year comboboxes in modals follow main comboboxes 
                copy_year_month_to_modals(){
                    this.year = this.year_report = this.year_cal;
                    this.month = this.month_report = this.month_cal;
                },
                return_sick_or_vac(data){
                    if (data == null){
                        return 'brak'
                    }else{
                        return data
                    }
                },
                calculate_diff(hours, job_time) {
                    return hours - job_time
                },
                printToPdf(){
                    var pdf_options = {
                        filename: 'raport.pdf',
                        image: { type: 'png', quality: 1 },
                        html2canvas: { scale: 2 },
                        jsPDF: {format: 'a4', orientation: 'landscape'}
                    };
                    html2pdf().set(pdf_options).from(document.getElementById('report')).save().then(() => {
                        this.margin_top_for_statistics_report = 0;
                    }
                    );
                },
                return_shift_count(shift_list, shift) {
                    for (let in_shift in shift_list) {
                        if (in_shift == shift){
                            return shift_list[in_shift]
                        }
                    }
                    return 0
                },
                add_to_shifttype_name_list(shift_list) {
                    for (let shift in shift_list) {
                        this.shifttype_name_list.push(shift)
                    }
                },
                create_schedule() {
                    console.log("checked_workpalce below");
                    console.log(this.checked_workplace);
                    this.loading = true
                    axios
                        .post(this.create_schedule_url,
                            {
                                workplace_list: this.checked_workplace,
                                year: this.year,
                                month: this.month
                            }
                        )
                        .then(response => {
                                this.loading = false;
                                this.year_cal = this.year;
                                this.month_cal = this.month;
                                if (this.checked_workplace.length > 0) {
                                    this.selected_workplace = this.checked_workplace[0];
                                }
                                this.fetch_data();
                            }
                        )
                },
                fetch_data() {
                    this.checked_workplace = [];
                    axios
                        .get(this.base_url, {params: {'year': this.year_cal, 'month': this.month_cal}})
                        .then(response => {
                                this.shifttype_name_list = []
                                this.fetched_schedule = response.data;
                                this.statistics = response.data['statistics'];
                                console.log(this.fetched_schedule);
                                this.inflate_checked_workplace();
                                this.statistics = this.sort_object_of_objects(this.statistics, 'order_number');
                            }
                        )
                        .then(() => {
                                if (Object.values(this.statistics).length != 0){
                                    this.add_to_shifttype_name_list(Object.values(this.statistics)[0].shift_type)
                                }
                            });
                    axios
                        .get(this.employee_list_url)
                        .then(response => {
                                this.available_workers = response.data;
                            }
                        );
                    axios
                        .get(this.shift_type_list_url)
                        .then(response => {
                                this.available_shift_types = response.data;
                            }
                        );
                    this.fetch_shift_types_for_each_workplace().then(result => {
                        this.shift_types_for_each_workplace = result;
                        });

                    this.copy_year_month_to_modals();
                    this.fetch_report_data(); 
                },
                fetch_report_data(){
                    axios
                        .get('{% url 'schedule_report_get' 123456789 %}'.replace(/123456789/, this.selected_unit), {params: {'year': this.year_report, 'month': this.month_report}})
                        .then(response => {this.workdays_for_each_employee = response.data;});
                    this.fetch_schedule_for_each_workplace().then(result => {
                        this.schedule_for_each_workplace = result;
                    }).then(() => {
                        this.check_report_workplace_availability(this.schedule_for_each_workplace);
                    });
                },
                check_report_workplace_availability(schedule_for_workplace){
                    this.available_workplace_report = [];
                    if (schedule_for_workplace.length > 0) {
                        schedule_for_workplace.forEach(workplace_schedule => {
                            
                            if (workplace_schedule.schedule.days != null) {
                                for (const day of Object.keys(workplace_schedule.schedule.days)) {
                                    if (workplace_schedule.schedule.days[day].length > 0){
                                        this.available_workplace_report.push(workplace_schedule.schedule.workplace_id);
                                        break;
                                    }
                                }
                            }

                        });

                        this.checked_workplace_report = this.available_workplace_report;
                    }
                },
                fill_schedule_for_chosen_workplace(schedule_for_workplace, checked_workplaces){
                    this.schedule_for_chosen_workplace = schedule_for_workplace.filter(schedule => checked_workplaces.includes(schedule.schedule.workplace_id));
                },
                change_workplace() {
                    try {
                        this.selected_workplace = this.select_workplace[this.selected_unit][0]['id']
                    } catch {

                    }
                    this.fetch_data()
                },
                async fetch_shift_types_for_each_workplace(){
                    const shiftTypes_to_workplace = [];
                    for (let i=0; i<this.current_workplace.length; i++){
                        
                        const shiftType_base_url = '{% url 'shiftType-list' 123456789 %}'.replace(/123456789/, this.current_workplace[i].id);
                           
                        await axios.get(shiftType_base_url).then(response => {
                            shiftTypes_to_workplace.push({workplace: this.current_workplace[i], shiftTypes: response.data});
                        });
                            
                    }
                    return shiftTypes_to_workplace;
                },
                async fetch_schedule_for_each_workplace(){
                    const schedules_to_workplace = [];
                    for (let i=0; i<this.current_workplace.length; i++){

                        const reportSchedules_base_url = '{% url 'schedule_get' 123456789 %}'.replace(/123456789/, this.current_workplace[i].id);

                        await axios.get(reportSchedules_base_url, {params: {'year': this.year_report, 'month': this.month_report}}).then(response => {
                            schedules_to_workplace.push({workplace: this.current_workplace[i], schedule: response.data});
                        });
                    }
                    return schedules_to_workplace;
                },
                active_days_to_string_abbr_array(active_days_numeric){
                    const abbr_to_day=["Pn", "Wt", "Śr", "Cz", "Pt", "Sb", "Nd"];
                    let abbreviations = [];

                    if (typeof active_days_numeric == "string" && active_days_numeric.length === 7) {
                        for(let day=0; day < active_days_numeric.length; day++){
                            if (active_days_numeric.charAt(day) == '1') {
                                abbreviations.push(abbr_to_day[day]);
                            }
                        }
                    }
                    else {
                        return [];
                    }

                    return abbreviations;
                },
                callApiManualChange(method, specific_shift_id, employee_id, shift_type_id, workplace_id, date_python_format){
                    switch (method) {
                        case 'put':
                            console.log('PUT: Shift: '+specific_shift_id+' Employee: '+employee_id);
                            this.putApiShiftManage(specific_shift_id, employee_id);
                            break;
                        
                        case 'delete':
                            console.log('DELETE: Shift: '+specific_shift_id);
                            this.deleteApiShiftManage(specific_shift_id);
                            break;
                        
                        case 'post':
                            console.log('POST: Shift_type: '+shift_type_id+' Employee: '+employee_id +' Date: '+date_python_format +' Workplace: '+workplace_id);
                            this.postApiShiftManage(shift_type_id, employee_id, date_python_format, workplace_id);
                            break;

                        default:
                            console.log('error message: \n you\'ve tried to call unhandled rest api method');
                    }                  
                },
                /* UPDATE EXISTING SHIFT */
                putApiShiftManage(specific_shift_id, employee_id){
                    let put_url = '{% url 'shift_manage' %}';
                    axios
                        .put(put_url,
                            {
                                Shift: specific_shift_id,
                                Employee: employee_id
                            }
                        )
                        .then(response => {
                                this.fetch_data();
                            }
                        )
                },
                /* DELETE EXISTING SHIFT */
                deleteApiShiftManage(specific_shift_id){
                    let delete_url = '{% url 'shift_manage' %}';
                    axios
                        .delete(delete_url,
                            {data:{Shift: specific_shift_id}}
                        )
                        .then(response => {
                                this.fetch_data();
                            }
                        )
                },
                /* ADD NEW SHIFT */
                postApiShiftManage(shift_type_id, employee_id, date_python_format, workplace_id){
                    let post_url = '{% url 'shift_manage' %}';
                    axios
                        .post(post_url,
                            {
                                Date: date_python_format,
                                Employee: employee_id,
                                Shift_type: shift_type_id,
                                Workplace: workplace_id,
                            }
                        )
                        .then(response => {
                                this.fetch_data();
                            }
                        )
                },
                inflate_checked_workplace() {
                    if(this.current_workplace != null){
                        for (let workplace of this.current_workplace){
                            this.checked_workplace.push(workplace.id)
                        }
                    }
                },
            },
            computed: {
                base_url: {
                    get() {
                        return '{% url 'schedule_get' 123456789 %}'.replace(/123456789/, this.selected_workplace);
                    }
                },
                employee_list_url: {
                    get() {
                        return '{% url 'employee-list' %}';
                    }
                },
                shift_type_list_url: {
                    get() {
                        return '{% url 'shiftType-list' 123456789 %}'.replace(/123456789/, this.selected_workplace);
                    }
                },
                current_workplace: {
                    get() {
                        return this.select_workplace[this.selected_unit]
                    }
                },
            },
            mounted() {
                try {
                    this.selected_workplace = this.select_workplace[this.selected_unit][0]['id']
                } catch {

                }
                this.fetch_data()
            },
        }).mount('#vue-app');

        </script>
    {% endif %}
{% endblock vue-content %}
