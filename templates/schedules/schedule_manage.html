{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{#START/added calendar#}
{% block head %}
    <link rel="stylesheet" href="{% static 'css/schedules/schedule.css' %}">
    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    </script>
{% endblock head %}
{#STOP/added calendar#}

{% block content %}
    <nav style aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'units_manage' %}"
                                           class="breadcrumb-link">{{ user.user_org }}</a></li>
            <li class="breadcrumb-item current-subpage">Grafiki</li>
        </ol>
        <h2 class="breadcrumb-title"><a href="{% url 'units_manage' %}">
            <i class="material-icons breadcrumb-go-back-icon">arrow_back_ios</i></a>Zarządzanie grafikami</h2>
        </h2>
        <hr class="breadcrumb">
    </nav>

    <button type="button" class="m-1 btn btn-success d-flex justify-content-center align-content-between"
            data-bs-toggle="modal" data-bs-target="#generateScheduleModal">
        Stwórz grafik
    </button>

    {#    START/added calendar#}
    <div id="vue-app">

        <div id="calendar-filters" class="filter-calendar-container">

            <select class="pn--select" v-model="month" v-on:change="fetch_data">
                <option v-for="label in month_labels" :value="label.id">
                    [[ label.name ]]
                </option>
            </select>

            <select class="pn--select" v-model="year" v-on:change="fetch_data">
                <option v-for="av_year in available_years" :value="av_year">
                    [[ av_year ]]
                </option>
            </select>

            <select class="pn--select" v-model="selected_unit" v-on:change="change_workplace">
                <option v-for="unit in select_unit" :value="unit.id">
                    [[ unit.name ]]
                </option>
            </select>

            <select class="pn--select" v-model="selected_workplace" v-on:change="fetch_data">
                <option v-for="workplace in current_workplace" :value="workplace.id">
                    [[ workplace.name ]]
                </option>
            </select>
        </div>

        <work-calendar
                :year="year"
                :month="month"
                :unit_id="selected_unit"
                :workplace_id="selected_workplace"
                :employee_id="employee_id"
                :show_for_workplace="show_for_workplace"
                :schedule="fetched_schedule">
        </work-calendar>

        {#    END/added calendar#}

        <div class="modal fade" id="generateScheduleModal" tabindex="-1"
             aria-labelledby="generateScheduleLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="schedule_form" v-on:submit.prevent="create_schedule">
                        {% csrf_token %}
                        <div class="modal-header" v-if="loading == false">
                            <h5 class="modal-title" id="generateScheduleLabel">Utwórz nowy grafik</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body" v-if="loading == false">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="year" class="form-label">Rok</label>
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control" v-model="year" required>
                                </div>

                                <div class="col-md-6">
                                    <label for="month" class="form-label">Miesiąc</label>
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control" v-model="month" required>
                                </div>

                                <label class="form-label">Działy uwzględnione w grafiku:</label>

                                <div v-for="(workplace, i) in current_workplace" :key="workplace.id">
                                    <div class="col-md-6">
                                        <label class="form-label">w [[ workplace.name ]] </label>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <input v-bind:id="workplace.id" v-bind:value="workplace.id" type="checkbox"
                                               checked v-model="checked_workplace">
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="modal-footer" v-if="loading == false">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                            <button type="submit" class="btn btn-primary">Wygeneruj</button>
                        </div>

                        <div v-if="loading">
                            <h3 class="text-center">Waiting</h3>
                            <img src="{% static 'img/Loading_icon.gif' %}" alt="Be patient"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {#    <div>#}
    {#                <h1>Utwórz nowy grafik</h1>#}
    {#                <form id="schedule_form" action method="post">#}
    {#                    {% csrf_token %}#}
    {#                    <label>Data startu</label>#}
    {#                    <input type="date" name="date_start" required>#}
    {#                    <label>Data końca</label>#}
    {#                    <input type="date" name="date_end" required>#}
    {#        {% for workplace in workplace_list %}#}
    {#            <label>Czy uzwględnić {{ workplace.name }} w grafiku?</label>#}
    {#            <input type="checkbox" checked name="{{ workplace.name }}_checkbox">#}
    {#        {% endfor %}#}
    {#        <input type="submit">#}
    {#        </form>#}
    {#    </div>#}

{% endblock %}


{% block vue-content %}
    <script type="module">
        import WorkCalendar from "{% static 'js/components/WorkCalendar.js' %}";

        const {createApp} = Vue
        createApp({
            delimiters: ["[[", "]]"],
            components: {
                WorkCalendar,
            },
            data() {
                return {
                    fetched_schedule: null,
                    month_str: '5',
                    year_str: '2022',
                    employee_id: 1,
                    show_for_workplace: true,
                    selected_unit: {{ default_unit }},
                    select_unit: {{ select_unit | safe}},
                    select_workplace: {{ select_workplace | safe }},
                    selected_workplace: null,
                    create_schedule_url: '{% url 'schedule_create' %}',
                    year: new Date().getFullYear(),
                    month: new Date().getMonth(),
                    checked_workplace: [],
                    loading: false,
                    month_labels: [
                        {id: 1, name: 'January'},
                        {id: 2, name: 'February'},
                        {id: 3, name: 'March'},
                        {id: 4, name: 'April'},
                        {id: 5, name: 'May'},
                        {id: 6, name: 'June'},
                        {id: 7, name: 'July'},
                        {id: 8, name: 'August'},
                        {id: 9, name: 'September'},
                        {id: 10, name: 'October'},
                        {id: 11, name: 'November'},
                        {id: 12, name: 'December'},
                    ],
                    available_years: [
                        new Date().getFullYear(),
                        new Date().getFullYear() - 1,
                        new Date().getFullYear() - 2,
                        new Date().getFullYear() - 3,
                        new Date().getFullYear() - 4,
                        new Date().getFullYear() - 5,
                        new Date().getFullYear() + 1,
                        new Date().getFullYear() + 2,
                    ],
                }
            },
            methods: {
                create_schedule() {
                    this.loading = true
                    axios
                        .post(this.create_schedule_url,
                            {
                                workplace_list: this.checked_workplace,
                                year: this.year,
                                month: this.month
                            }
                        )
                        .then(response => {
                                this.loading = false
                            }
                        )
                },
                fetch_data() {
                    axios
                        .get(this.base_url, {params: {'year': this.year, 'month': this.month}})
                        .then(response => {
                                this.fetched_schedule = response.data;
                            }
                        )
                },
                change_workplace() {
                    try {
                        this.selected_workplace = this.select_workplace[this.selected_unit][0]['id']
                    } catch {

                    }
                    this.fetch_data()
                },
            },
            computed: {
                base_url: {
                    get() {
                        return '{% url 'schedule_get' 123456789 %}'.replace(/123456789/, this.selected_workplace);
                    }
                },
                current_workplace: {
                    get() {
                        return this.select_workplace[this.selected_unit]
                    }
                }
            },
            mounted() {

                try {
                    this.selected_workplace = this.select_workplace[this.selected_unit][0]['id']
                } catch {

                }
                this.fetch_data()

            },
        }).mount('#vue-app');

    </script>

{% endblock vue-content %}
