{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/organizations/workplace_closing.css' %}">
    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    </script>
{% endblock head %}

{% block content %}
    <div id="vue-app">
        <div class="row d-flex justify-content-between align-items-center">
            <div class="col d-flex justify-content-start">
                <h3 class="content-title">Wyłączenia działów</h3>
            </div>
            <div class="row align-items-center mb-1">
            <div class="col-auto mb-1">
                <label class="col-form-label" for="unitSelect">Jednostka:</label>
            </div>
            <div class="col-auto mb-1">
                <select id="unitSelect" class="form-select" v-model="selected_unit" v-on:change="workplace_list_fetch">
                    <option :value="null" disabled hidden>Wybierz z listy</option>
                    <option v-for="unit in unit_list" :value="unit.id">
                        [[ unit.name ]]
                    </option>
                </select>
            </div>
            
            <div class="col-auto mb-1">
                <label class="col-form-label" for="workplaceSelect">Dział:</label>
            </div>
            <div class="col-auto mb-1">
                <select id="workplaceSelect" class="form-select" v-model="selected_workplace"
                        v-on:change="current_closing_compute">
                    <option :value="null" disabled hidden>Wybierz z listy</option>
                    <option v-for="workplace in workplaces_list" :value="workplace.id">
                        [[ workplace.name ]]
                    </option>
                </select>
            </div>
            </div>
        </div>

        <div>
            <h5 style="margin-top: 35px">Wykluczenia</h5>
            <div class="list-group">
                <div v-for="closure in current_closing_list" :key="closure.id" class="list-group-item list-group-item-action position-static">
                    <div class="closure_table_box">
                        <div>[[ closure.workplace_obj.name ]]: [[ closure.start ]] - [[ closure.end ]]</div>
                        <button v-on:click="" class="material-icons" 
                                style="border: none; background-color: rgba(0, 0, 255, 0);">delete_outline</button>
                    </div>
                </div>
            </div>
            <button data-bs-target="#addBadAssignmentModal" data-bs-toggle="modal" data-bs-dismiss="modal" 
                    class="btn btn-outline-primary" style="margin-top: 15px; margin-bottom: 15px">Dodaj</button> 
        </div>


    </div>
{% endblock %}

{% block vue-content %}

    <script type="module">
        const {createApp} = Vue
        createApp({
            delimiters: ["[[", "]]"],
            data() {
                return {
                    response: null,
                    workplace_closing_list: null,
                    workplace_closing_url: '/organizations/api/workplace_closing/',
                    selected_unit: null,
                    selected_workplace: null,
                    unit_list: null,
                    workplaces_list: null,
                    current_closing_list: [],
                }
            },
            methods: {
                fetch_data() {
                    axios
                        .get(this.workplace_closing_url)
                        .then(response => {
                                this.workplace_closing_list = response.data;
                                console.log(this.workplace_closing_list)
                            }
                        )
                        .catch(error => {this.response = error.response.data});
                },
                fetch_unit_data(){
                    let units_url = '{% url 'unit-list' %}';
                    axios
                        .get(units_url)
                        .then(response_unit_data => (this.unit_list = response_unit_data.data))
                        .catch(error => {this.response = error.response.data});
                },
                workplace_list_fetch() {
                    if (this.selected_unit != null){
                        axios
                            .get(this.workplace_url)
                            .then(response_workplace_data => (this.workplaces_list = response_workplace_data.data))
                            .catch(error => {this.response = error.response.data})
                    }
                },
                current_closing_compute() {
                    let list = []
                    for (let closure of this.workplace_closing_list){
                        if (closure.workplace == this.selected_workplace){
                            list.push(closure)
                        }
                    }
                    this.current_closing_list = list
                },
            },
            computed: {
                workplace_url: {
                    get() {
                        return '{% url 'workplace-list' 123456789 %}'.replace(/123456789/, this.selected_unit);
                    }
                },
                
            },
            mounted() {
                this.fetch_data()
                this.fetch_unit_data()
                this.workplace_list_fetch()
            },
        }).mount('#vue-app');

    </script>
{% endblock vue-content %}